{% extends 'base.html' %}

{% block content %}
<section class="max-w-7xl mx-auto px-6 py-10">
    <h1 class="text-5xl font-bold text-center text-[#9d0c0c] mb-8">Pembayaran</h1>

    <div class="overflow-x-auto bg-white shadow-lg rounded-2xl p-6">
        <table class="min-w-full text-center border-collapse">
            <thead class="bg-[#9d0c0c] text-white uppercase text-sm">
                <tr>
                    <th class="py-3 px-4 rounded-tl-2xl">ID</th>
                    <th class="py-3 px-4">Status</th>
                    <th class="py-3 px-4">Total Price</th>
                    <th class="py-3 px-4">Paid</th>
                    <th class="py-3 px-4">Due</th>
                    <th class="py-3 px-4 rounded-tr-2xl">Actions</th>
                </tr>
            </thead>
            <tbody id="transactions-container" class="text-gray-700 text-sm divide-y divide-gray-200"></tbody>
        </table>
    </div>

    {% include 'modals/modal.html' %}
</section>

<script>
    "use strict";

    const TRANSACTIONS_API_ENDPOINT = "{% url 'payment:show_transactions_json' %}";
    const TRANSACTIONS_CONTAINER = document.getElementById('transactions-container');

    let transactionData = [];

    async function fetchTransactionData() {
        try {
            const response = await fetch(TRANSACTIONS_API_ENDPOINT, {
                headers: { 'Accept': 'application/json' },
            });
            transactionData = await response.json() || [];
        } catch (e) {
            console.error("Error loading transactions:", e);
        }
    }

    function getReadablePaymentStatus(paymentStatus) {
        if (paymentStatus === "complete") {
            return "Complete";
        }
        return "Pending";
    }

    function renderTransactionData() {
        TRANSACTIONS_CONTAINER.replaceChildren();

        transactionData.forEach(transaction => {
            const id = transaction.id;

            const statusColor = transaction.payment_status === "complete"
                ? "text-green-600 font-semibold"
                : "text-yellow-500 font-semibold";

            const paymentStatusReadable = getReadablePaymentStatus(transaction.payment_status);

            const row = document.createElement("tr");
            row.className = "hover:bg-gray-50 transition";

            const payButton = `<button onclick="showTransactionPaymentModal('${id}')"
            class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg mx-1">Pay</button>`;
            const completeButton = `<button onclick="showTransactionCompletionModal('${id}')"
            class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-lg mx-1">Complete</button>`;
            const deleteButton = `<button onclick="showTransactionDeletionModal('${id}')"
            class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg mx-1">Delete</button>`;

            const viewTransactionUrl = "{% url 'payment:view_transaction' '00000000-0000-0000-0000-000000000000' %}".replace("00000000-0000-0000-0000-000000000000", id);

            row.innerHTML = `
            <td class="py-3 px-4 text-blue-700 font-medium">
                <a href='${viewTransactionUrl}' class="hover:underline">${id}</a>
            </td>
            <td class="py-3 px-4 ${statusColor}">${paymentStatusReadable}</td>
            <td class="py-3 px-4">${transaction.total_price}</td>
            <td class="py-3 px-4">${transaction.amount_paid}</td>
            <td class="py-3 px-4">${transaction.amount_due}</td>
            <td class="py-3 px-4">${payButton}${completeButton}${deleteButton}</td>
        `;

            TRANSACTIONS_CONTAINER.appendChild(row);
        });
    }

    function init() {
        fetchTransactionData().then(renderTransactionData);
    }

    window.onload = init;
</script>
{% endblock content %}
