{% extends 'base.html' %}

{% block content %}
<p id="productForm"></p>
<h1 class="font-bold text-6xl text-[#9d0c0c]">Transaction details</h1>
<p id="transaction-id"><span class="font-bold">Id:</span></p>
<p id="transaction-total-price"><span class="font-bold">Total price:</span></p>
<p id="transaction-amount-paid"><span class="font-bold">Paid:</span></p>
<p id="transaction-amount-due"><span class="font-bold">Due:</span></p>
<p id="transaction-payment-status"><span class="font-bold">Status:</span></p>
<p id="transaction-date"><span class="font-bold">Created at:</span></p>
<p id="transaction-updated-at"><span class="font-bold">Updated at:</span></p>
<table class="w-full">
<thead>
    <tr>
        <th>Name</th>
        <th>Amount</th>
        <th>Price</th>
    </tr>
</thead>
<tbody id="entries-container">
</tbody>
</table>
{% include 'modals/modal.html' %}
<script>
"use strict";

const TRANSACTION_ID = "{{ transaction_id }}";
const TRANSACTION_API_ENDPOINT = "{% url 'payment:show_json_by_id' '00000000-0000-0000-0000-000000000000' %}".replace('00000000-0000-0000-0000-000000000000', TRANSACTION_ID);

const TRANSACTION_ID_ELEMENT =
    document.getElementById('transaction-id');
const TRANSACTION_TOTAL_PRICE =
    document.getElementById('transaction-total-price');
const TRANSACTION_AMOUNT_PAID =
    document.getElementById('transaction-amount-paid');
const TRANSACTION_AMOUNT_DUE =
    document.getElementById('transaction-amount-due');
const TRANSACTION_PAYMENT_STATUS =
    document.getElementById('transaction-payment-status');
const TRANSACTION_DATE =
    document.getElementById('transaction-date');
const TRANSACTION_UPDATED_AT =
    document.getElementById('transaction-updated-at');
const ENTRIES_CONTAINER = document.getElementById('entries-container');

let transaction = null;

async function fetchTransactionData() {
    try {

        const response = await fetch(TRANSACTION_API_ENDPOINT, {
            headers: { 'Accept': 'application/json' },
        });

        transaction = await response.json() || [];

    } catch (e) {
        throw e;
    }
}

function renderTransactionData() {

    const payment_status = transaction.fields.payment_status == 'paid'
        ? `<span class="text-green-500 font-bold">Paid</span>`
        : `<span class="text-yellow-500 font-bold">Due</span>`;
    const created_at = (new Date(transaction.fields.date)).toString();
    const updated_at = (new Date(transaction.fields.updated_at)).toString();
    TRANSACTION_ID_ELEMENT.innerHTML = `<span class="font-bold">Id:</span> ${transaction.pk}`;
    TRANSACTION_TOTAL_PRICE.innerHTML = `<span class="font-bold">Total price:</span> ${transaction.fields.total_price}`;
    TRANSACTION_AMOUNT_PAID.innerHTML = `<span class="font-bold">Paid:</span> ${transaction.fields.amount_paid}`;
    TRANSACTION_AMOUNT_DUE.innerHTML = `<span class="font-bold">Due:</span> ${transaction.fields.amount_due}`;
    TRANSACTION_PAYMENT_STATUS.innerHTML = `<span class="font-bold">Status:</span> ${payment_status}`;
    TRANSACTION_DATE.innerHTML = `<span class="font-bold">Created at:</span> ${created_at}`;
    TRANSACTION_UPDATED_AT.innerHTML = `<span class="font-bold">Updated at:</span> ${updated_at}`;

    ENTRIES_CONTAINER.replaceChildren();
    transaction.fields.entries.forEach(e => {

        const row = document.createElement('tr');
        
        const productUrl = "{% url 'main:show_product' '00000000-0000-0000-0000-000000000000' %}".replace('00000000-0000-0000-0000-000000000000', e.id);

        row.innerHTML = `
            <td><a href=${productUrl}><span class='font-bold'>${e.name}</span></a></td>
            <td>${e.amount}</td>
            <td>${e.price}</td>
        `;
        ENTRIES_CONTAINER.appendChild(row);

    });
}

function init(e) {
    fetchTransactionData().then(
        value => { renderTransactionData(); },
        error => { console.error("Error loading transactions:", e); }
    );
}

window.onload = init;
</script>
{% endblock content %}
