{% load static %}
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Shopping Cart</title>
    <link rel="stylesheet" href="{% static 'css/global.css' %}">
    <script src="{% static 'js/toast.js' %}"></script>
</head>
<body>

<div class="cart-container">
    <h1>Shopping Cart</h1>

    {% if cart.items.all %}
    <table class="cart-table">
        <thead>
            <tr>
                <th>Product</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Total</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for item in cart.items.all %}
            <tr data-item-id="{{ item.id }}">
                <td>{{ item.product.product_name }}</td>
                <td class="price" data-price="{{ item.price }}">$ {{ item.price|floatformat:0 }}</td>
                <td>
                    <div>
                        <button type="button" class="qty-btn minus" data-id="{{ item.id }}">−</button>
                        <span class="qty-display" data-id="{{ item.id }}">{{ item.quantity }}</span>
                        <button type="button" class="qty-btn plus" data-id="{{ item.id }}">+</button>
                    </div>
                </td>
                <td class="subtotal" data-subtotal="{{ item.subtotal }}" data-id="{{ item.id }}">$ {{ item.subtotal|floatformat:0 }}</td>
                <td>
                    <div>
                        <form 
                            action="{% url 'cart:update_cart_item' item.id %}" 
                            method="post" 
                            class="update-cart-form"
                            data-product-name="{{ item.product.product_name }}"
                        >
                            {% csrf_token %}
                            <input type="hidden" name="quantity" value="{{ item.quantity }}">
                            <button type="submit" class="cart-btn">Change</button>
                        </form>

                        <form 
                            action="{% url 'cart:remove_from_cart' item.id %}" 
                            method="post" 
                            class="remove-cart-form"
                        >
                            {% csrf_token %}
                            <button type="submit" class="cart-btn">Delete</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="cart-total">
        Total Price: $ {{ cart.total_price|floatformat:0 }}
    </div>

    <div class="cart-actions">
        <a href="{% url 'main:show_main' %}">Continue Shopping</a>
        <a href="{% url 'cart:checkout_review' %}" id="checkout-btn">Checkout</a>
    </div>

    {% else %} 
        <p>Your shopping cart is empty.</p>
        <a class="cart-btn" href="{% url 'main:show_main' %}">Shop Now</a>
    {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const updateForms = document.querySelectorAll(".update-cart-form");
    const removeForms = document.querySelectorAll(".remove-cart-form");

    // --- Format semua harga dengan titik ribuan ---
    function formatUSD(number) {
        return number.toLocaleString("id-ID");
    }

    // Format harga dan subtotal awal
    document.querySelectorAll(".price").forEach(cell => {
        const value = parseFloat(cell.dataset.price || 0);
        cell.textContent = `$ ${formatUSD(value)}`;
    });

    document.querySelectorAll(".subtotal").forEach(cell => {
        const value = parseFloat(cell.dataset.subtotal || 0);
        cell.textContent = `$ ${formatUSD(value)}`;
    });

    const totalEl = document.querySelector(".cart-total");
    if (totalEl) {
        const text = totalEl.textContent.replace(/\D/g, '');
        const value = parseFloat(text || 0);
        totalEl.innerHTML = `Total Price: $ ${formatUSD(value)}`;
    }

    // --- Tombol + dan − ---
    document.querySelectorAll(".qty-btn").forEach(btn => {
        btn.addEventListener("click", function() {
            const id = this.dataset.id;
            const display = document.querySelector(`.qty-display[data-id='${id}']`);
            const formQty = document.querySelector(`.update-cart-form[action*='${id}'] input[name='quantity']`);
            let value = parseInt(display.textContent);
            if (this.classList.contains("plus")) value++;
            else if (this.classList.contains("minus") && value > 1) value--;
            display.textContent = value;
            formQty.value = value;
        });
    });

    // --- Ubah item (AJAX) ---
    updateForms.forEach(form => {
        form.addEventListener("submit", async function(e) {
            e.preventDefault();
            const formData = new FormData(form);
            const url = form.action;

            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "X-Requested-With": "XMLHttpRequest" },
                    body: formData
                });
                const data = await response.json();
                if (data.success) {
                    // Update total cart
                    if (data.total_price) {
                        document.querySelector(".cart-total").textContent =
                            `Total Price: $ ${formatUSD(data.total_price)}`;
                    }
                    // Update subtotal item
                    if (data.subtotal && data.item_id) {
                        const subtotalCell = document.querySelector(`.subtotal[data-id='${data.item_id}']`);
                        if (subtotalCell) {
                            subtotalCell.textContent = `$ ${formatUSD(data.subtotal)}`;
                        }
                    }
                    showToast("success", data.message || "Jumlah produk diperbarui!");
                } else {
                    showToast("error", data.error || "Gagal mengubah jumlah produk!");
                }
            } catch {
                showToast("error", "Terjadi kesalahan jaringan!");
            }
        });
    });

// --- Hapus item (AJAX) ---
    removeForms.forEach(form => {
        form.addEventListener("submit", async function(e) {
            e.preventDefault();
            const url = form.action;
            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "X-Requested-With": "XMLHttpRequest" },
                    body: new FormData(form)
                });
                if (response.ok) {
                    showToast("success", "Product removed from cart.");
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast("error", "Failed to delete product.");
                }
            } catch {
                showToast("error", "A network error occurred!");
            }
        });
    });
});
</script>

</body>
</html>
