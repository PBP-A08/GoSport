{% extends 'base.html' %}

{% block content %}
<section class="max-w-4xl mx-auto px-6 py-10">
    <h1 class="text-5xl font-bold text-[#9d0c0c] mb-8 text-center">Transaction Details</h1>

    <div class="bg-white shadow-lg rounded-2xl p-6 mb-6">
        <p id="transaction-id" class="mb-2"><span class="font-bold">Id:</span></p>
        <p id="transaction-total-price" class="mb-2"><span class="font-bold">Total price:</span></p>
        <p id="transaction-amount-paid" class="mb-2"><span class="font-bold">Paid:</span></p>
        <p id="transaction-amount-due" class="mb-2"><span class="font-bold">Due:</span></p>
        <p id="transaction-payment-status" class="mb-2"><span class="font-bold">Status:</span></p>
        <p id="transaction-date" class="mb-2"><span class="font-bold">Created at:</span></p>
        <p id="transaction-updated-at" class="mb-2"><span class="font-bold">Updated at:</span></p>
    </div>

    <div class="overflow-x-auto bg-white shadow-lg rounded-2xl p-6">
        <table class="min-w-full text-center border-collapse">
            <thead class="bg-[#9d0c0c] text-white uppercase text-sm">
                <tr>
                    <th class="py-3 px-4 rounded-tl-2xl">Name</th>
                    <th class="py-3 px-4">Amount</th>
                    <th class="py-3 px-4 rounded-tr-2xl">Price</th>
                </tr>
            </thead>
            <tbody id="entries-container" class="text-gray-700 text-sm divide-y divide-gray-200"></tbody>
        </table>
    </div>

    {% include 'modals/modal.html' %}
</section>

<script>
    "use strict";

    const TRANSACTION_ID = "{{ transaction_id }}";
    const TRANSACTION_API_ENDPOINT = "{% url 'payment:show_json_by_id' '00000000-0000-0000-0000-000000000000' %}".replace('00000000-0000-0000-0000-000000000000', TRANSACTION_ID);

    const TRANSACTION_ID_ELEMENT = document.getElementById('transaction-id');
    const TRANSACTION_TOTAL_PRICE = document.getElementById('transaction-total-price');
    const TRANSACTION_AMOUNT_PAID = document.getElementById('transaction-amount-paid');
    const TRANSACTION_AMOUNT_DUE = document.getElementById('transaction-amount-due');
    const TRANSACTION_PAYMENT_STATUS = document.getElementById('transaction-payment-status');
    const TRANSACTION_DATE = document.getElementById('transaction-date');
    const TRANSACTION_UPDATED_AT = document.getElementById('transaction-updated-at');
    const ENTRIES_CONTAINER = document.getElementById('entries-container');

    let transaction = null;

    async function fetchTransactionData() {
        try {
            const response = await fetch(TRANSACTION_API_ENDPOINT, { headers: { 'Accept': 'application/json' } });
            transaction = await response.json() || [];
        } catch (e) {
            console.error("Error loading transaction:", e);
        }
    }

    function renderTransactionData() {
        const payment_status = transaction.payment_status === 'paid'
            ? `<span class="text-green-600 font-semibold">Paid</span>`
            : `<span class="text-yellow-500 font-semibold">Due</span>`;
        const created_at = new Date(transaction.date).toLocaleString();
        const updated_at = new Date(transaction.updated_at).toLocaleString();

        TRANSACTION_ID_ELEMENT.innerHTML = `<span class="font-bold">Id:</span> ${transaction.id}`;
        TRANSACTION_TOTAL_PRICE.innerHTML = `<span class="font-bold">Total price:</span> ${transaction.total_price}`;
        TRANSACTION_AMOUNT_PAID.innerHTML = `<span class="font-bold">Paid:</span> ${transaction.amount_paid}`;
        TRANSACTION_AMOUNT_DUE.innerHTML = `<span class="font-bold">Due:</span> ${transaction.amount_due}`;
        TRANSACTION_PAYMENT_STATUS.innerHTML = `<span class="font-bold">Status:</span> ${payment_status}`;
        TRANSACTION_DATE.innerHTML = `<span class="font-bold">Created at:</span> ${created_at}`;
        TRANSACTION_UPDATED_AT.innerHTML = `<span class="font-bold">Updated at:</span> ${updated_at}`;

        ENTRIES_CONTAINER.replaceChildren();
        transaction.entries.forEach(e => {
            const row = document.createElement('tr');
            row.className = "hover:bg-gray-50 transition";

            const productUrl = "{% url 'main:show_product' '00000000-0000-0000-0000-000000000000' %}".replace('00000000-0000-0000-0000-000000000000', e.id);

            row.innerHTML = `
            <td class="py-2 px-4 text-blue-700 font-medium"><a href="${productUrl}" class="hover:underline">${e.name}</a></td>
            <td class="py-2 px-4">${e.amount}</td>
            <td class="py-2 px-4">${e.price}</td>
        `;
            ENTRIES_CONTAINER.appendChild(row);
        });
    }

    function init() {
        fetchTransactionData().then(renderTransactionData);
    }

    window.onload = init;
</script>
{% endblock content %}
